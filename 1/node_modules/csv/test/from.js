// Generated by CoffeeScript 1.4.0

/*
Test CSV - Copyright David Worms <open@adaltas.com> (BSD Licensed)
*/


(function() {
  var csv, fs, generator, should;

  require('coffee-script');

  fs = require('fs');

  should = require('should');

  csv = process.env.CSV_COV ? require('../lib-cov/csv') : require('../src/csv');

  generator = process.env.CSV_COV ? require('../lib-cov/generator') : require('../src/generator');

  describe('from', function() {
    describe('auto', function() {
      it('should parse a string', function(next) {
        return csv().from('"1","2","3","4","5"').on('record', function(record) {
          return record.length.should.eql(5);
        }).on('end', function() {
          return next();
        });
      });
      it('should parse an array', function(next) {
        return csv().from(['"1","2","3","4","5"', ['1', '2', '3', '4', '5']]).on('record', function(record) {
          return record.length.should.eql(5);
        }).on('end', function() {
          return next();
        });
      });
      it('should parse a file', function(next) {
        return csv().from("" + __dirname + "/from/file.csv").on('record', function(record) {
          return record.length.should.eql(5);
        }).on('end', function() {
          return next();
        });
      });
      return it('should parse a stream', function(next) {
        return csv().from(fs.createReadStream("" + __dirname + "/from/file.csv")).on('record', function(record) {
          return record.length.should.eql(5);
        }).on('end', function() {
          return next();
        });
      });
    });
    describe('path', function() {
      it('should read a file', function(next) {
        return csv().from.path("" + __dirname + "/from/file.csv").on('record', function(record) {
          record.length.should.eql(5);
          return record.should.eql(['1', '2', '3', '4', '5']);
        }).on('end', function() {
          return next();
        });
      });
      return it('should strip UTF-8 BOM', function(next) {
        return csv().from.path("" + __dirname + "/from/file_bom.csv").on('record', function(record) {
          record.length.should.eql(5);
          return record.should.eql(['1', '2', '3', '4', '5']);
        }).on('end', function() {
          return next();
        });
      });
    });
    describe('stream', function() {
      return it('should be able to pause', function(next) {
        var paused;
        paused = false;
        return csv().from.stream(generator({
          start: true,
          duration: 500
        })).on('record', function(record, index) {
          var resume,
            _this = this;
          paused.should.be["false"];
          if (index === 5) {
            this.pause();
            this.paused.should.be["true"];
            paused = true;
            resume = function() {
              paused = false;
              return _this.resume();
            };
            return setTimeout(resume, 100);
          }
        }).on('end', function() {
          paused.should.be["false"];
          return next();
        });
      });
    });
    describe('string', function() {
      it('should call record event when record is provided in from', function(next) {
        return csv().from.string('"1","2","3","4","5"').on('record', function(record) {
          return record.length.should.eql(5);
        }).on('end', function() {
          return next();
        });
      });
      it('should include empty last column', function(next) {
        return csv().from.string('"1","2","3","4","5",').on('record', function(record) {
          return record.length.should.eql(6);
        }).on('end', function() {
          return next();
        });
      });
      it('should include empty last column surrounded by quotes', function(next) {
        return csv().from.string('"1","2","3","4","5",""').on('record', function(record) {
          return record.length.should.eql(6);
        }).on('end', function() {
          return next();
        });
      });
      return it('should include empty last column if followed by linebreak', function(next) {
        return csv().from.string('"1","2","3","4","5",""\n').on('record', function(record) {
          return record.length.should.eql(6);
        }).on('end', function() {
          return next();
        });
      });
    });
    it('Test string without destination', function(next) {
      var string;
      string = "20322051544,1979.0,8.8017226E7,ABC,45,2000-01-01\n28392898392,1974.0,8.8392926E7,DEF,23,2050-11-27";
      return csv().from.string(string).on('record', function(record, index) {
        index.should.be.below(2);
        if (index === 0) {
          return record[0].should.eql('20322051544');
        } else if (index === 1) {
          return record[0].should.eql('28392898392');
        }
      }).on('end', function(count) {
        count.should.eql(2);
        return next();
      });
    });
    return describe('array', function() {
      it('should emit all records as objects', function(next) {
        var data, onRecordCount, transformCount;
        transformCount = onRecordCount = 0;
        data = [
          {
            field1: 'val11',
            field2: 'val12',
            field3: 'val13'
          }, {
            field1: 'val21',
            field2: 'val22',
            field3: 'val23'
          }
        ];
        return csv().from.array(data).transform(function(record, index) {
          transformCount++;
          record.should.eql(data[index]);
          return record;
        }).on('record', function(record, index) {
          onRecordCount++;
          return record.should.eql(data[index]);
        }).to(function(data) {
          data.should.eql('val11,val12,val13\nval21,val22,val23');
          transformCount.should.equal(2);
          onRecordCount.should.equal(2);
          return next();
        });
      });
      it('should handle column option set to true', function(next) {
        var data, onRecordCount, transformCount;
        transformCount = onRecordCount = 0;
        data = [
          ['field1', 'field3'], {
            field1: 'val11',
            field2: 'val12',
            field3: 'val13'
          }, {
            field1: 'val21',
            field2: 'val22',
            field3: 'val23'
          }
        ];
        return csv().from.array(data, {
          columns: true
        }).transform(function(record, index) {
          transformCount++;
          record.should.eql({
            field1: data[index + 1].field1,
            field3: data[index + 1].field3
          });
          return record;
        }).on('record', function(record, index) {
          onRecordCount++;
          return record.should.eql({
            field1: data[index + 1].field1,
            field3: data[index + 1].field3
          });
        }).to(function(data) {
          data.should.eql('val11,val13\nval21,val23');
          transformCount.should.equal(2);
          onRecordCount.should.equal(2);
          return next();
        });
      });
      return it('should filter by columns', function(next) {
        var data, onRecordCount, transformCount;
        transformCount = onRecordCount = 0;
        data = [
          {
            field1: 'val11',
            field2: 'val12',
            field3: 'val13'
          }, {
            field1: 'val21',
            field2: 'val22',
            field3: 'val23'
          }
        ];
        return csv().from.array(data, {
          columns: ['field1', 'field3']
        }).transform(function(record, index) {
          transformCount++;
          record.should.eql({
            field1: data[index].field1,
            field3: data[index].field3
          });
          return record;
        }).on('record', function(record, index) {
          onRecordCount++;
          return record.should.eql({
            field1: data[index].field1,
            field3: data[index].field3
          });
        }).to(function(data) {
          data.should.eql('val11,val13\nval21,val23');
          transformCount.should.equal(2);
          onRecordCount.should.equal(2);
          return next();
        });
      });
    });
  });

}).call(this);
